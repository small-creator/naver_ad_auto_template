# .github/workflows/property-automation.yml
# ë„¤ì´ë²„ë¶€ë™ì‚° ë§¤ë¬¼ ìžë™í™” ì›Œí¬í”Œë¡œìš°

name: Property Automation

on:
  # ë§¤ì¼ ìžì • 1ë¶„ì— ìžë™ ì‹¤í–‰ (KST ê¸°ì¤€)
  schedule:
    - cron: '1 15 * * *'  # UTC 15:01 = KST 00:01
  
  # ìˆ˜ë™ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      property_numbers:
        description: 'ë§¤ë¬¼ë²ˆí˜¸ë“¤ (ì½¤ë§ˆë¡œ êµ¬ë¶„, ì„ íƒì‚¬í•­)'
        required: false
        default: ''
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  check-schedule:
    runs-on: ubuntu-latest
    outputs:
      has_schedule: ${{ steps.check.outputs.has_schedule }}
      property_count: ${{ steps.check.outputs.property_count }}
      properties: ${{ steps.check.outputs.properties }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for scheduled properties
      id: check
      run: |
        if [ -f "data/scheduled_properties.json" ]; then
          echo "has_schedule=true" >> $GITHUB_OUTPUT
          
          # JSONì—ì„œ ë§¤ë¬¼ ì •ë³´ ì¶”ì¶œ
          properties=$(cat data/scheduled_properties.json | jq -r '.properties | join(",")')
          count=$(cat data/scheduled_properties.json | jq -r '.total_count')
          
          echo "properties=${properties}" >> $GITHUB_OUTPUT
          echo "property_count=${count}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ ì˜ˆì•½ëœ ë§¤ë¬¼ ë°œê²¬: ${count}ê°œ"
          echo "ðŸ“Š ë§¤ë¬¼ë²ˆí˜¸: ${properties}"
        else
          echo "has_schedule=false" >> $GITHUB_OUTPUT
          echo "ðŸ“ ì˜ˆì•½ëœ ë§¤ë¬¼ ì—†ìŒ"
        fi

  automation:
    needs: check-schedule
    runs-on: ubuntu-latest
    if: needs.check-schedule.outputs.has_schedule == 'true' || github.event.inputs.property_numbers != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright
    
    - name: Install Playwright browsers and dependencies
      run: |
        playwright install chromium
        playwright install-deps chromium
    
    - name: Determine property numbers
      id: properties
      run: |
        if [ -n "${{ github.event.inputs.property_numbers }}" ]; then
          # ìˆ˜ë™ ìž…ë ¥ëœ ë§¤ë¬¼ë²ˆí˜¸ ì‚¬ìš©
          echo "properties=${{ github.event.inputs.property_numbers }}" >> $GITHUB_OUTPUT
          echo "source=manual" >> $GITHUB_OUTPUT
        else
          # ì˜ˆì•½ íŒŒì¼ì—ì„œ ë§¤ë¬¼ë²ˆí˜¸ ì‚¬ìš©
          echo "properties=${{ needs.check-schedule.outputs.properties }}" >> $GITHUB_OUTPUT
          echo "source=scheduled" >> $GITHUB_OUTPUT
        fi
    
    - name: Run multi-property automation
      run: |
        echo "ðŸš€ ë‹¤ì¤‘ ë§¤ë¬¼ ìžë™í™” ì‹œìž‘..."
        echo "ðŸ“‹ ì²˜ë¦¬í•  ë§¤ë¬¼: ${{ steps.properties.outputs.properties }}"
        echo "ðŸ“Š ë§¤ë¬¼ ê°œìˆ˜: $(echo '${{ steps.properties.outputs.properties }}' | tr ',' '\n' | wc -l)"
        echo "ðŸ”§ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ github.event.inputs.test_mode || 'false' }}"
        
        python multi_property_automation.py
      env:
        LOGIN_ID: ${{ secrets.LOGIN_ID }}
        LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
        PROPERTY_NUMBERS: ${{ steps.properties.outputs.properties }}
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        TZ: Asia/Seoul
    
    - name: Archive completed schedule
      if: always() && steps.properties.outputs.source == 'scheduled'
      run: |
        # ì‹¤í–‰ ì™„ë£Œ í›„ ì˜ˆì•½ íŒŒì¼ì„ archiveë¡œ ì´ë™ (ì„±ê³µ/ì‹¤íŒ¨ ë¬´ê´€)
        timestamp=$(date +"%Y%m%d_%H%M%S")
        mkdir -p archive
        
        if [ -f "data/scheduled_properties.json" ]; then
          # ì‹¤í–‰ ê²°ê³¼ì— ë”°ë¼ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ìž¥
          if [ "${{ job.status }}" == "success" ]; then
            mv data/scheduled_properties.json archive/completed_${timestamp}.json
            echo "âœ… ì„±ê³µ: ì˜ˆì•½ íŒŒì¼ì„ archiveë¡œ ì´ë™: completed_${timestamp}.json"
          else
            mv data/scheduled_properties.json archive/failed_${timestamp}.json
            echo "âŒ ì‹¤íŒ¨: ì˜ˆì•½ íŒŒì¼ì„ archiveë¡œ ì´ë™: failed_${timestamp}.json"
          fi
        fi
    
    - name: Create execution log
      if: always()
      run: |
        timestamp=$(date +"%Y%m%d_%H%M%S")
        mkdir -p results
        
        cat > results/execution_${timestamp}.json << EOF
        {
          "executed_at": "$(date -Iseconds)",
          "properties": "${{ steps.properties.outputs.properties }}",
          "property_count": $(echo '${{ steps.properties.outputs.properties }}' | tr ',' '\n' | wc -l),
          "test_mode": "${{ github.event.inputs.test_mode || 'false' }}",
          "source": "${{ steps.properties.outputs.source }}",
          "status": "${{ job.status }}"
        }
        EOF
        
        echo "ðŸ“ ì‹¤í–‰ ë¡œê·¸ ìƒì„±: results/execution_${timestamp}.json"
    
    - name: Commit results
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add archive/ results/ || true
        git commit -m "ðŸ¤– ìžë™í™” ì‹¤í–‰ ì™„ë£Œ $(date +"%Y-%m-%d %H:%M:%S")" || echo "No changes to commit"
        git push || echo "Push failed or no changes"
    
    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-screenshots-${{ github.run_number }}
        path: "*.png"
        retention-days: 7
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-logs-${{ github.run_number }}
        path: |
          *.log
          results/
        retention-days: 30

  no-schedule:
    needs: check-schedule
    runs-on: ubuntu-latest
    if: needs.check-schedule.outputs.has_schedule == 'false' && github.event.inputs.property_numbers == ''
    
    steps:
    - name: No automation needed
      run: |
        echo "â„¹ï¸ ì‹¤í–‰í•  ìžë™í™” ìž‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤."
        echo ""
        echo "ðŸ“‹ ì˜ˆì•½ëœ ë§¤ë¬¼: ì—†ìŒ"
        echo "ðŸ“ ìˆ˜ë™ ìž…ë ¥: ì—†ìŒ"
        echo ""
        echo "ðŸ’¡ ë§¤ë¬¼ì„ ì˜ˆì•½í•˜ë ¤ë©´:"
        echo "1. ë¡œì»¬ GUIì—ì„œ ë§¤ë¬¼ ì„ íƒ"
        echo "2. GitHubì— scheduled_properties.json ì—…ë¡œë“œ"
        echo "3. ë‹¤ìŒ ìžì •ì— ìžë™ ì‹¤í–‰ë¨"
